<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        margin: 0;
      }
    </style>

    <script src="//unpkg.com/three"></script>
    <script src="node_modules/3d-force-graph/dist/3d-force-graph.js"></script>
    <script src="//unpkg.com/dat.gui"></script>
  </head>

  <body onresize="resizeGraph()">
    <div id="3d-graph"></div>

    <script type="module">
      import { FilmPass } from "https://cdn.skypack.dev/three@0.136/examples/jsm/postprocessing/FilmPass.js";
      import { UnrealBloomPass } from "https://cdn.skypack.dev/three@0.136/examples/jsm/postprocessing/UnrealBloomPass.js";

      const Graph = ForceGraph3D()(document.getElementById("3d-graph"))
        // .nodeThreeObject(
        //   ({ id }) =>
        //     new THREE.Mesh(
        //       new THREE.SphereGeometry(4),
        //       new THREE.MeshStandardMaterial({
        //         color: id.unknown ? "red" : "blue",
        //         transparent: true,
        //         roughness: 0,
        //         metalness: 1,
        //         // opacity: id.unknown ? 0.2 : 1,
        //       })
        //     )
        // )
        .jsonUrl("data/wiki.json")
        .nodeId("id")
        .linkSource("from")
        .linkTarget("to")
        .nodeLabel("name")
        .nodeAutoColorBy("category")
        // .nodeColor((id) => (id.unknown ? "red" : "blue"))
        // .nodeColor((node) => "rgba(255, 0, 0, node.opacity)")
        .nodeOpacity(0.9)
        .nodeVisibility((id) => !id.unknown)
        .linkLabel("edge_type")
        .linkAutoColorBy("edge_type")
        .linkWidth(8)
        .linkCurvature(0.2)
        .linkOpacity(0.5)
        // .linkDirectionalParticles(10)
        // .linkDirectionalParticles(() => (settings.particles ? 10 : 0))
        // .linkDirectionalParticleWidth(2)
        // .backgroundColor("#171717")
        .backgroundColor("#000017")
        // .backgroundColor("#000077")
        .onNodeClick((node) => {
          // Click to arrive at node
          const distance = 40;
          const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

          Graph.cameraPosition(
            {
              x: node.x * distRatio,
              y: node.y * distRatio,
              z: node.z * distRatio,
            }, // new position
            node, // lookAt ({ x, y, z })
            3000 // ms transition duration
          );
        });

      // function setZPosition() {
      //   Graph.graphData().nodes.forEach((n) => {
      //     n.fz = 0;
      //   });
      // }

      // Graph.setZPosition();

      // Graph.nodeColor(randomColor);

      // function randomColor(n) {
      //   const r = 255;
      //   const g = 0;
      //   const b = 0;
      //   const a = n.opacity;
      //   return `rgba(${r}, ${g}, ${b}, ${a})`;
      // }

      // function refreshColors() {
      //   Graph.nodeColor(randomColor);
      //   // Graph.graphData().nodes.forEach((n) => {
      //   // n.fz = zPositionForNode(n);
      //   // });
      // }

      const filmPass = new FilmPass(
        0.8, // noise intensity
        0, // scanline intensity
        0, // scanline count
        false // grayscale
      );

      const bloomPass = new UnrealBloomPass();
      bloomPass.strength = 0.2;
      bloomPass.radius = 1;
      bloomPass.threshold = 0.1;

      // const bokehPass = new BokehPass();

      document.addEventListener("keydown", onDocumentKeyDown, false);
      function onDocumentKeyDown(event) {
        var keyCode = event.which;
        if (
          keyCode == 81 // q for refit view
        ) {
          Graph.zoomToFit(
            3000 // ms transition duration
          );
        }
      }

      function resizeGraph() {
        if (Graph) {
          var height = document.getElementById("3d-graph").clientHeight;
          var width = document.getElementById("3d-graph").clientWidth;

          Graph.width(width);
          Graph.height(height);
          Graph.controls().handleResize();
        }
      }

      //Define GUI
      const Settings = function () {
        this.rotate = false;
        this.particles = false;
      };

      const settings = new Settings();
      const gui = new dat.GUI();

      gui.add(settings, "rotate");
      gui.add(settings, "particles");

      let angle = 0;
      const distance = 1000;
      setInterval(() => {
        if (settings.rotate) {
          Graph.cameraPosition({
            x: distance * Math.sin(angle),
            z: distance * Math.cos(angle),
          });
          angle += Math.PI / 300;
        }
      }, 16);

      const view = Graph.postProcessingComposer();
      // view.addPass(bloomPass);
      view.addPass(filmPass);
      // view.addPass(bokehPass);
    </script>
  </body>
</html>
