<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        margin: 0;
      }
    </style>

    <script src="//unpkg.com/three"></script>
    <script src="node_modules/3d-force-graph/dist/3d-force-graph.js"></script>
    <script src="//unpkg.com/dat.gui"></script>
  </head>

  <body onresize="resizeGraph()">
    <div id="3d-graph" style="width: 100%; height: 100%"></div>

    <script type="module">
      import { FilmPass } from "https://cdn.skypack.dev/three@0.136/examples/jsm/postprocessing/FilmPass.js";
      import { UnrealBloomPass } from "https://cdn.skypack.dev/three@0.136/examples/jsm/postprocessing/UnrealBloomPass.js";

      const Graph = ForceGraph3D()(document.getElementById("3d-graph"))
        .jsonUrl("data/wiki.json")
        .nodeId("id")
        .linkSource("from")
        .linkTarget("to")
        .nodeLabel("name")
        .nodeVal((n) => {
          return 1.4 ** n.size;
        })
        .nodeAutoColorBy("community")
        .nodeOpacity(0.9)
        .linkLabel("edge_type")
        .linkAutoColorBy("edge_type")
        .linkWidth((e) => e.edge_importance_normalised + 0.4)
        .linkCurvature(0.2)
        .linkOpacity(0.5)
        .backgroundColor("#000077")
        // Click on node to approach it
        .onNodeClick((node) => {
          const distance = 40;
          const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

          Graph.cameraPosition(
            {
              // new position
              x: node.x * distRatio,
              y: node.y * distRatio,
              z: node.z * distRatio,
            },
            node, // lookAt ({ x, y, z })
            3000 // ms transition duration
          );
        });

      function setZPosition() {
        Graph.graphData().nodes.forEach((n) => {
          n.fz = zPositionForNode(n);
        });
      }

      function zPositionForNode(node) {
        // return node.connectivity;
        return node.unknown ? 10 : 100;
        // return 30 * Math.random();
      }

      Graph.onEngineTick(() => {
        setZPosition();
        Graph.onEngineTick(() => {});
      });

      document.addEventListener("keydown", onDocumentKeyDown, false);
      function onDocumentKeyDown(event) {
        var keyCode = event.which;
        if (
          keyCode == 81 // q for refit view
        ) {
          Graph.zoomToFit(
            3000 // ms transition duration
          );
        }
      }

      function resizeGraph() {
        if (Graph) {
          var height = document.getElementById("3d-graph").clientHeight;
          var width = document.getElementById("3d-graph").clientWidth;

          Graph.width(width);
          Graph.height(height);
          Graph.controls().handleResize();
        }
      }

      //Define GUI
      const Settings = function () {
        this.rotate = false;
        this.particles = false;
      };

      const settings = new Settings();
      const gui = new dat.GUI();

      gui.add(settings, "rotate");
      gui.add(settings, "particles");

      let angle = 0;
      const distance = 1000;
      setInterval(() => {
        if (settings.rotate) {
          Graph.cameraPosition({
            x: distance * Math.sin(angle),
            z: distance * Math.cos(angle),
          });
          angle += Math.PI / 300;
        }
      }, 16);

      // Passes
      const filmPass = new FilmPass(
        0.8, // noise intensity
        0, // scanline intensity
        0, // scanline count
        false // grayscale
      );
      Graph.postProcessingComposer().addPass(filmPass);
      const bloomPass = new UnrealBloomPass();
      bloomPass.strength = 0.2;
      bloomPass.radius = 1;
      bloomPass.threshold = 0.1;
      Graph.postProcessingComposer().addPass(bloomPass);
    </script>
  </body>
</html>
